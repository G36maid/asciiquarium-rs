# Asciiquarium-rs Specification

## Overview

Asciiquarium-rs is a Rust implementation of the classic ASCII art aquarium animation. This specification is based on analysis of the original Perl asciiquarium v1.1 by Kirk Baucom and defines the requirements for a faithful Rust port using Ratatui.

## Core Architecture

### Entity System
The application uses an entity-component system where all animated objects are entities with the following properties:

- **Position**: 3D coordinates (x, y, depth)
- **Shape**: ASCII art representation (single frame or animation sequence)
- **Color**: Color masks for different parts of the entity
- **Movement**: Velocity and animation callbacks
- **Lifecycle**: Spawn time, death conditions, respawn behavior
- **Physics**: Collision detection and response
- **Depth**: Z-order for proper layering

### Depth Layers (Z-order)
```
0-1:   GUI elements (future use)
2:     Sharks, water surface effects  
3-20:  Fish (multiple layers for schooling)
21:    Seaweed
22:    Castle (background)
2-9:   Water surface (multiple layers for wave effect)
```

## Environment

### Water Surface
- 4-layer animated water surface using tileable segments
- Segments: `~`, `^^^^ ^^^  ^^^   ^^^    ^^^^`, `^^^^      ^^^^     ^^^    ^^`, `^^      ^^^^      ^^^    ^^^^^^`
- Cyan colored, repeats across screen width
- Creates wave-like animation effect

### Castle
- Static background element positioned at bottom-right
- Multi-line ASCII art with red and yellow color highlights
- Provides depth and visual interest to the scene

### Seaweed
- Randomly placed vertical seaweed plants
- 2-frame animation (swaying left/right): `(` and ` )`
- Random height (3-7 characters)
- Green colored
- Lives 8-12 minutes before respawning
- Animation speed: 0.25-0.30 fps
- Spawning frequency: Every 5 seconds when below target (⚠️ **Known Issue**: Spawning rate differs from original Perl version)

## Fish System

### Fish Types

#### Classic Fish (Old Generation)
Multiple species with left/right directional sprites:
- Small fish with simple `><>` style designs
- Medium fish with more detailed ASCII art
- Each species has unique shape and color pattern

#### New Fish (Enhanced Generation)
More detailed fish species with:
- Complex multi-line ASCII art
- Detailed color masks
- Available only in non-classic mode

### Fish Behavior
- **Spawning**: Based on screen size (screen_area / 350 fish)
- **Movement**: Horizontal swimming only (no vertical movement, matching original)
- **Bubble Generation**: Random chance to emit bubbles while swimming
- **Collision**: Fish die when touching sharks or other deadly entities
- **Schooling**: Multiple depth layers create schooling illusion
- **Lifecycle**: Continuous respawning to maintain population

### Fish Animation
- Direction-based sprites (left-facing and right-facing)
- Smooth horizontal movement across screen
- Die when reaching screen edges (off-screen death)

## Bubbles

### Bubble System
- Generated by fish at random intervals
- Start at fish position (adjusted for fish size and direction)
- 5-frame animation sequence: `.`, `o`, `O`, `O`, `O`
- Cyan colored
- Vertical movement (rising)
- Pop when reaching water surface
- Physics-enabled for collision detection

## Random Objects

### Sharks
- Large predatory entities with teeth
- 2-directional sprites (left/right)
- White/cyan colored with red teeth
- Move horizontally across screen
- Separate teeth entity for collision detection
- Deadly to fish on contact

### Whales
- Large entities with animated water spouts
- 2-directional sprites
- Blue/cyan colored
- 7-frame water spout animation sequence
- Spouts appear above whale periodically

### Ships
- Surface-level entities
- Move horizontally across water surface
- Detailed ASCII art representation

### Sea Monsters
- Large underwater entities
- Two variants with different designs
- Move horizontally with tentacle-like appendages

### Big Fish
- Larger fish variants
- Two different species
- More detailed ASCII art than regular fish

## User Interface

### Controls
- `q`: Quit application
- `r`: Redraw/restart (recreates all entities)
- `p`: Toggle pause/unpause
- `Ctrl+C`: Emergency exit

### Command Line Options
- `-c`: Classic mode (only show original fish species)

### Display
- Full terminal screen utilization
- Color support (8 basic colors)
- Smooth animation at ~10 FPS
- Dynamic screen size adaptation

## Technical Requirements

### Performance
- Handle 20+ concurrent animated entities
- Maintain smooth animation on typical terminal sizes
- Efficient collision detection system
- Memory management for entity lifecycle

### Rendering
- Terminal-based rendering using Ratatui
- Color support with fallback for monochrome terminals
- Proper depth sorting for overlapping entities
- Screen size adaptation and reflow

### Animation System
- Frame-based animation with configurable timing
- Entity movement with velocity and acceleration
- Callback system for complex behaviors
- Time-based lifecycle management

## Entity Specifications

### Fish Entity Properties
```rust
struct Fish {
    position: (f32, f32, u8),     // x, y, depth
    velocity: (f32, f32),         // dx, dy per frame
    species: FishSpecies,         // determines appearance
    direction: Direction,         // Left or Right
    bubble_timer: f32,           // time until next bubble
    age: Duration,               // time alive
}
```

### Animation Frame System
```rust
struct AnimationFrame {
    shape: Vec<String>,          // ASCII art lines
    color_mask: Vec<String>,     // Color coding per character
    duration: Duration,          // frame display time
}
```

### Collision System
- Bounding box collision detection
- Entity type-based collision rules
- Collision callbacks for custom behavior
- Separate collision entities (e.g., shark teeth)

## Implementation Phases

### Phase 1: Core Framework
- Entity system foundation
- Basic rendering pipeline
- Input handling
- Screen management

### Phase 2: Environment
- Water surface animation
- Castle background
- Seaweed system
- Basic fish

### Phase 3: Advanced Entities
- Bubble system
- Sharks and predation
- Whales with spouts
- Random object spawning

### Phase 4: Polish
- Collision refinement
- Performance optimization
- Classic mode implementation
- Additional fish species

## Known Issues

### Spawning Frequency Discrepancies
- **Seaweed Spawning**: Current implementation spawns seaweed every 5 seconds when below target count, but this frequency differs from the original Perl version. Needs investigation and calibration against original spawning behavior.
- **Future Calibration**: All spawning timings should be verified against the original asciiquarium behavior for authenticity.

### Color System Status
- **Fish Colors**: ✅ **FIXED** - Color randomization now matches original Perl `rand_color` function with proper number-to-color mapping
- **Color Masks**: ✅ **FIXED** - Fish now use randomized color masks identical to original implementation

### Movement System Status
- **Fish Movement**: ✅ **FIXED** - Fish now move horizontally only, matching original Perl implementation (`callback_args => [ $speed, 0, 0 ]`)
- **Authentic Behavior**: Removed incorrect vertical drift and random movement variations

## Data Assets

All ASCII art and color masks from the original Perl implementation will be preserved, including:
- 20+ fish species designs
- Shark variants
- Whale designs
- Ship artwork
- Monster designs
- Castle artwork
- Seaweed patterns

## Compatibility

The Rust implementation should be functionally equivalent to the original Perl version while leveraging Rust's performance and safety features. The visual output should be indistinguishable from the original when run in the same terminal environment.