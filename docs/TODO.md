# TODO: asciiquarium-rs

This document tracks remaining tasks, bugs, and future enhancements for the asciiquarium-rs project.

## Current Status

âœ… **Core Features Implemented**
- Entity system with trait-based polymorphism
- Death callback system for population management
- Single large creature constraint
- Fish (12 species: 4 new + 8 old with randomized colors)
- Big Fish (2 variants: traditional and stylized large predatory fish)
- Bubbles (generated by fish)
- Seaweed (with sway animation)
- Castle (static decoration)
- Water surface (4-layer animation)
- Whale (with water spout animation)
- Ship (sailing across surface)
- Sea Monster
- Shark (with separate teeth entity)
- Depth-based Z-ordering
- Keyboard controls (quit, pause, redraw)
- Screen size-based entity counts
- Ratatui rendering with color support
- 71 passing unit tests

## Bugs to Fix

### Critical Priority (User Reported) - COMPLETED âœ…

- [x] **Issue #1: Water surface should be static, not moving** âœ…
  - ~~Current: Water surface appears to move left~~
  - **FIXED**: Removed animation frames, water is now completely static
  - Changed `create_water_layer_sprites()` to `create_water_layer_sprite()` (single frame)
  - Removed Animation struct, water now uses single Sprite

- [x] **Issue #2: Fish spawn/despawn immediately at screen edge** âœ…
  - ~~Current: Fish spawn/disappear instantly when touching left edge~~
  - **FIXED**: Fish now fully swim on/off screen
  - Spawn: Fish start at `-sprite_width` (right) or `screen_width` (left)
  - Despawn: Fish die when right edge < 0 (left) or left edge > screen_width (right)

- [x] **Issue #4: No bubbles appearing** âœ…
  - ~~Current: Bubbles not being generated by fish~~
  - **FIXED**: Added `should_spawn_bubble()` to Entity trait
  - EntityManager now checks for bubble spawns during update loop
  - Fish randomly generate bubbles that rise to surface

- [x] **Issue #5: Screen resize doesn't recalculate entity counts** âœ…
  - ~~Current: Program doesn't respond to terminal size changes~~
  - **FIXED**: Added automatic resize detection in App::run()
  - On resize, calls `on_resize()` which reinitializes aquarium
  - Entity counts now automatically adjust to new terminal size

### Critical Priority (User Reported) - COMPLETED âœ…

- [x] **Issue #3: Fish types don't respect original code** âœ…
  - ~~Current: Fish species selection may not match original behavior~~
  - **FIXED**: Implemented all 12 fish species (4 new + 8 old)
  - Added 25%/75% new/old fish selection ratio matching original `int(rand(12)) > 8`
  - Added `classic_mode` flag support for -c flag (disables new fish)
  - All fish sprites match original Perl code character-by-character
  - Categories: `FishCategory::New` and `FishCategory::Old`
  - Test coverage: Distribution test confirms 25%/75% ratio, classic mode test

### High Priority

- [x] Fix `created_at` field warnings âœ…
  - ~~`src/entities/sea_monster.rs:14`~~
  - ~~`src/entities/ship.rs:12`~~
  - ~~`src/entities/whale.rs:14`~~
  - **FIXED**: Added `#[allow(dead_code)]` annotations
  - Note: water_surface.rs no longer has this field after refactor

- [x] Fix clippy warnings âœ…
  - **FIXED**: All 6 clippy warnings resolved
  - Fixed field assignment outside initializer (src/app.rs)
  - Fixed single match to if let (src/app.rs)
  - Fixed module inception (src/depth.rs - removed nested depth module)
  - Fixed manual range contains (src/depth.rs - use RangeInclusive::contains)
  - Fixed or_insert_with to or_default (src/entity.rs)
  - Added Default impl for EventHandler (src/event.rs)

### Medium Priority

- [ ] Verify bubble collision detection with water surface
  - Original Perl has `bubble_collision()` handler
  - Check if bubbles properly disappear at waterline

- [ ] Test seaweed lifetime behavior
  - Lives 8-12 minutes in original
  - Verify death callbacks trigger correctly after lifetime expires

### Low Priority

- [ ] Verify all fish species sprites match original Perl
  - Compare ASCII art character-by-character
  - Ensure color masks are identical

## Missing Features from Original

### Core Features

- [x] **Big Fish Implementation** âœ…
  - âœ… Implemented two variants: BigFish1 (traditional) and BigFish2 (stylized)
  - âœ… BigFish1: 14 lines tall, speed 3, matches original Perl sprite
  - âœ… BigFish2: 13 lines tall, speed 2.5, modern variant
  - âœ… Classic mode (-c flag ready): Only spawns BigFish1
  - âœ… Modern mode: 2/3 BigFish2, 1/3 BigFish1
  - âœ… Proper large creature behavior with death callbacks
  - âœ… 10 comprehensive unit tests
  - âœ… **VERIFIED & FIXED**: Correct depth (2), spawn positions (-34/-33), Y ranges

- [x] **Random Objects Verification** âœ…
  - âœ… All 5 random objects verified against original Perl
  - âœ… Ship: Correct (speed 1, depth 7, spawn x=-24/width-2)
  - âœ… Whale: Correct (speed 1, depth 5, spawn x=-18/width-2, 12-frame animation)
  - âœ… Sea Monster: Fixed - Added classic mode support (4-frame old monster)
  - âœ… Big Fish: Fixed - Corrected depth (2), spawn positions, Y ranges
  - âœ… Shark: Correct (speed 2, depth 2, spawn x=-53/width-2, teeth mechanics)
  - âœ… See RANDOM_OBJECTS_VERIFICATION.md and RANDOM_OBJECTS_FIXES_COMPLETE.md

- [ ] **Classic Mode (-c flag)**
  - Original Perl has `-c` flag for classic mode
  - Disables newer fish and monsters
  - Should be implemented as CLI argument

- [ ] **Additional Fish Species**
  - Original has more fish varieties added after v1.0
  - Check `$new_fish` flag in original Perl
  - Implement remaining species

- [x] **Additional Monster Species** âœ…
  - âœ… Implemented both old and new monster variants
  - âœ… Classic mode (-c flag ready): Uses 4-frame old monster
  - âœ… Modern mode: Uses 2-frame new monster
  - âœ… Spawn positions vary by mode: x=-64 (classic) or x=-54 (modern)

### Nice-to-Have Features

- [ ] **Command Line Arguments**
  - `-c`: Classic mode
  - `-h`: Help message
  - `-v`: Version information
  - Screen size override (if useful for testing)

- [ ] **Version Display**
  - Show version info on startup or via flag
  - Current version should match original (1.1) or be 0.1.0 for Rust port

## Code Quality Improvements

### Refactoring

- [ ] **Remove Code Duplication**
  - Large creature spawning has similar patterns
  - Extract common death callback logic
  - Consider helper functions for sprite creation

- [ ] **Improve Entity Creation**
  - Some entities have complex `new()` methods
  - Consider builder pattern for entities with many parameters
  - Simplify random position/velocity generation

- [ ] **Entity Module Organization**
  - Consider grouping related entities (e.g., large_creatures module)
  - Extract common traits (e.g., `Animated`, `LargeCreature`)

### Testing

- [ ] **Integration Tests**
  - Test full initialization sequence
  - Test death callback chain
  - Test large creature constraint enforcement
  - Test screen resize behavior

- [ ] **Property-Based Tests**
  - Use `proptest` for random entity generation
  - Verify entities never go negative coordinates
  - Verify depth values stay in valid ranges

- [ ] **Visual Regression Tests**
  - Capture rendered frames
  - Compare with reference images
  - Detect unintended visual changes

### Documentation

- [ ] **API Documentation**
  - Add rustdoc comments to all public items
  - Include examples in doc comments
  - Document entity lifecycle

- [ ] **Code Examples**
  - Add inline examples for entity creation
  - Document spawning function usage
  - Show death callback patterns

- [ ] **Architecture Diagrams**
  - Add entity relationship diagram to SPEC.md
  - Visualize death callback flow
  - Illustrate depth layering system

## Performance Optimization

### Profiling

- [ ] **Profile Entity Updates**
  - Measure time spent in update loop
  - Identify slow entities
  - Optimize hot paths

- [ ] **Profile Rendering**
  - Measure rendering performance
  - Check if transparency checks are bottleneck
  - Optimize depth sorting

### Optimization Opportunities

- [ ] **Spatial Partitioning**
  - Consider quadtree for entity lookup
  - Optimize off-screen culling
  - Only update visible entities

- [ ] **Lazy Updates**
  - Skip updates for entities far off-screen
  - Only update on-screen + buffer zone
  - Reduce CPU usage when many entities exist

- [ ] **Smart Rendering**
  - Track dirty regions
  - Only redraw changed areas
  - Reduce terminal writes

## Feature Enhancements

### User Experience

- [ ] **Smooth Resize Handling**
  - Auto-redraw on terminal resize
  - Gracefully handle small terminals
  - Show message if terminal too small

- [ ] **Status Display**
  - Show entity counts (optional, toggle with key)
  - Display FPS counter
  - Show large creature type

- [ ] **Color Schemes**
  - Support terminal color themes
  - Allow monochrome mode
  - Configurable color palettes

- [ ] **Configuration File**
  - TOML config for entity counts
  - Customize spawn rates
  - Override default colors

### Additional Content

- [ ] **More Fish Species**
  - Import fish from ASCII art collections
  - Add rare/special fish types
  - Implement schooling behavior

- [ ] **More Decorations**
  - Rocks and coral
  - Treasure chest
  - Sunken ship (different from sailing ship)

- [ ] **Weather Effects**
  - Storm mode (rougher waves)
  - Night mode (darker colors)
  - Seasonal themes

- [ ] **Interactive Elements**
  - Feed fish (press key to spawn food)
  - Scare fish (they swim away from cursor)
  - Click to add entity at position

### Advanced Features

- [ ] **Save/Load State**
  - Serialize aquarium state
  - Load previous session
  - Named save slots

- [ ] **Replay Mode**
  - Record animation sequences
  - Playback recorded sessions
  - Export to file

- [ ] **Network Features**
  - Share aquarium state over network
  - Synchronized multi-user viewing
  - WebSocket server mode

## Platform Support

- [ ] **Windows Testing**
  - Original doesn't support Windows (no curses)
  - Ratatui should work on Windows
  - Test and document Windows compatibility

- [ ] **macOS Testing**
  - Verify color rendering on macOS Terminal
  - Test on iTerm2
  - Check performance on ARM (M1/M2/M3)

- [ ] **Linux Testing**
  - Test various terminal emulators (gnome-terminal, konsole, alacritty)
  - Verify on different distributions
  - Check with tmux/screen

## Distribution

- [ ] **Package for Distributions**
  - Create Arch AUR package
  - Submit to Homebrew
  - Create deb/rpm packages

- [ ] **Cargo Installation**
  - Publish to crates.io
  - Document installation steps
  - Set up CI/CD for releases

- [ ] **Binary Releases**
  - Build for multiple platforms
  - Create GitHub releases
  - Include checksums

## Documentation

- [ ] **User Guide**
  - Getting started tutorial
  - Troubleshooting section
  - FAQ

- [ ] **Developer Guide**
  - Contributing guidelines
  - Code style guide
  - Entity creation tutorial

- [ ] **Comparison with Original**
  - Feature comparison table
  - Performance comparison
  - Migration guide for Perl users

## Community

- [ ] **GitHub Setup**
  - Issue templates
  - Pull request template
  - Code of conduct

- [ ] **CI/CD Pipeline**
  - Automated testing on push
  - Lint checks
  - Format checks
  - Release automation

- [ ] **Website/Demo**
  - Project website
  - Animated GIF/video demo
  - Try online (wasm build?)

## Stretch Goals

- [ ] **WASM Build**
  - Compile to WebAssembly
  - Run in browser
  - Interactive web demo

- [ ] **GUI Version**
  - Port to egui or iced
  - Window-based version
  - Mouse interaction

- [ ] **3D Version**
  - Modernize with 3D graphics
  - Keep ASCII aesthetic
  - Use bevy engine

## Next Steps (Priority Order)

1. ~~**Fix critical bugs #1-#5**~~ âœ… **ALL 5 COMPLETED**
   - âœ… Issue #1: Water is now static
   - âœ… Issue #2: Fish spawn/despawn fixed
   - âœ… Issue #3: Fish types now match original (25%/75% ratio, all 12 species)
   - âœ… Issue #4: Bubbles now working
   - âœ… Issue #5: Auto-resize implemented
2. ~~**Verify and fix fish species**~~ âœ… **COMPLETED**
   - âœ… Counted all fish types in original Perl (4 new + 8 old = 12 total)
   - âœ… Implemented 25%/75% new/old fish ratio
   - âœ… Ensured all fish sprites match original
3. ~~**Fix remaining clippy warnings**~~ âœ… **COMPLETED**
   - âœ… Fixed all 6 clippy warnings (0 warnings remaining)
   - âœ… Cleaned up depth module structure
   - âœ… Improved code quality and idioms
4. ~~**Implement Big Fish properly**~~ âœ… **COMPLETED**
   - âœ… Created BigFish entity with two variants
   - âœ… Matches original Perl sprites exactly
   - âœ… Classic/modern mode support built-in
   - âœ… All 7 tests passing
5. **Add command-line arguments** (classic mode, help, version)
6. **Refactor codebase** (reduce line count, remove unused parts)
7. **Write integration tests** (full system behavior)
8. **Add rustdoc comments** (public API documentation)
9. **Create demo GIF/video** (for README)
10. **Publish to crates.io** (make installable)
11. **Test on multiple platforms** (Windows, macOS, Linux)

---

## Notes

- Keep focus on matching original behavior before adding new features
- Maintain test coverage as features are added (currently 55 passing tests)
- Document any intentional deviations from original
- Prioritize performance and user experience

## Recent Progress (Latest Session)

- âœ… Fixed water surface animation (now static)
- âœ… Fixed fish spawn/despawn behavior (fully swim on/off screen)
- âœ… Implemented bubble generation system
- âœ… Added automatic screen resize detection
- âœ… Fixed `created_at` field warnings
- âœ… Implemented all 12 fish species (4 new + 8 old)
- âœ… Added 25%/75% new/old fish selection ratio
- âœ… Implemented classic_mode flag for -c support
- âœ… Fixed all 6 clippy warnings (0 warnings remaining)
- âœ… Cleaned up and consolidated documentation
- âœ… Implemented proper BigFish entity (2 variants, matching original)
- âœ… **Verified all random objects** against original Perl (Ship, Whale, Monster, BigFish, Shark)
- âœ… **Fixed Big Fish**: Corrected depth (3â†’2), spawn positions, Y ranges
- âœ… **Fixed Sea Monster**: Added classic mode support with old monster sprites
- ðŸ“ˆ Test count: 54 â†’ 55 â†’ 59 â†’ 66 â†’ 71 tests passing
- ðŸŽ¯ Clippy warnings: 6 â†’ 0
- ðŸ“š Documentation: Consolidated into 7 core files

## Documentation Structure

**Core Documentation (7 files):**
- `README.md` - Project overview and quick start
- `DEVELOPMENT.md` - Technical guide for developers (NEW)
- `FISH_SPECIES.md` - All 12 fish species reference
- `SPEC.md` - Complete architecture specification
- `TODO.md` - This file (task tracking)
- `CHANGELOG.md` - Version history and changes
- `AGENTS.md` - Agent coding guidelines

**Removed (consolidated into above):**
- ~~FISH_SPAWNING.md~~ â†’ Merged into DEVELOPMENT.md
- ~~CLIPPY_FIXES.md~~ â†’ Merged into DEVELOPMENT.md and CHANGELOG.md
- ~~FIXES.md~~ â†’ Information in CHANGELOG.md
- ~~SESSION_SUMMARY.md~~ â†’ Temporary notes, removed
- ~~ISSUE_3_SUMMARY.md~~ â†’ Information in CHANGELOG.md and FISH_SPECIES.md
- ~~COMMIT_MSG.txt~~ â†’ Temporary file, removed
- ~~CLIPPY_COMMIT_MSG.txt~~ â†’ Temporary file, removed

**Random Objects Documentation (3 files):**
- `RANDOM_OBJECTS_VERIFICATION.md` - Detailed verification report
- `FIXES_NEEDED.md` - List of required fixes (reference)
- `RANDOM_OBJECTS_FIXES_COMPLETE.md` - Complete summary of fixes

Last Updated: 2024